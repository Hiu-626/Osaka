<!DOCTYPE html>
<html lang="zh-HK">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>DuckTravel Planner</title>
    
    <!-- 1. Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

    <!-- 2. 你的原創設計設定 (Duck Theme) -->
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              duck: {
                yellow: '#FFD700',
                blue: '#1E90FF',
                red: '#FF4500',
                white: '#F7F9FC',
                dark: '#1e3a8a',
              }
            },
            fontFamily: {
              sans: ['ui-rounded', 'Nunito', 'Segoe UI', 'sans-serif'],
            }
          }
        }
      }
    </script>

    <style>
      .no-scrollbar::-webkit-scrollbar { display: none; }
      .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
      
      /* 你的原創背景設計 */
      body {
        background-color: #E0F2FE;
        background-image: radial-gradient(#60A5FA 1px, transparent 1px);
        background-size: 20px 20px;
        font-family: 'ui-rounded', sans-serif;
      }
    </style>

    <!-- 3. React & Firebase 引擎 -->
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "firebase/app": "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js",
        "firebase/firestore": "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js"
      }
    }
    </script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  </head>
  
  <body>
    <div id="root"></div>

    <!-- 4. 主程式 (設計 + 邏輯) -->
    <script type="text/babel" data-type="module">
      import React, { useState, useEffect } from 'react';
      import { createRoot } from 'react-dom/client';
      import { initializeApp } from 'firebase/app';
      import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, deleteDoc, doc } from 'firebase/firestore';

      // ==========================================
      // 【請填入你的 Firebase Config】
      // ==========================================
      const firebaseConfig = {
        apiKey: "AIzaSyC2FhBEJC_VilXXm2i2l9rVjXthFUUQuao", 
        authDomain: "travel-planner-d59ab.firebaseapp.com",
        projectId: "travel-planner-d59ab",
        storageBucket: "travel-planner-d59ab.firebasestorage.app",
        messagingSenderId: "845991687518",
        appId: "1:845991687518:web:8d356490f811f27fa6cbcf"
      };

      // 初始化 (加了防錯檢查)
      let app, db;
      try {
        app = initializeApp(firebaseConfig);
        db = getFirestore(app);
      } catch(e) { console.error("Firebase 設定有誤", e); }

      function App() {
        const [days, setDays] = useState("");
        const [budget, setBudget] = useState("");
        const [status, setStatus] = useState("");
        const [loading, setLoading] = useState(false);
        const [history, setHistory] = useState([]);

        // 自動讀取歷史紀錄
        useEffect(() => {
          if (!db) return;
          const q = query(collection(db, "trips"), orderBy("createdAt", "desc"));
          const unsubscribe = onSnapshot(q, (snapshot) => {
            const tripsData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            setHistory(tripsData);
          });
          return () => unsubscribe();
        }, []);

        const handleCalculateAndSave = async () => {
          if (!days || !budget) return;
          setLoading(true);
          const totalBudget = parseFloat(budget);
          const numDays = parseInt(days);
          const dailyAverage = (totalBudget / numDays).toFixed(0);

          try {
            await addDoc(collection(db, "trips"), {
              days: numDays,
              totalBudget: totalBudget,
              dailyAverage: parseFloat(dailyAverage),
              createdAt: new Date()
            });
            setStatus("儲存成功！");
            setDays(""); setBudget("");
          } catch (error) {
            setStatus("錯誤：" + error.message);
          } finally {
            setLoading(false);
            setTimeout(() => setStatus(""), 2000);
          }
        };

        const handleDelete = async (id) => {
          if(confirm("確定刪除這筆紀錄？")) {
            await deleteDoc(doc(db, "trips", id));
          }
        };

        return (
          <div className="min-h-screen flex flex-col items-center justify-center p-4">
            
            {/* 卡片：輸入區 */}
            <div className="bg-white/90 backdrop-blur-md p-8 rounded-2xl shadow-xl w-full max-w-md border border-duck-blue/30 mb-8 relative overflow-hidden">
              {/* 裝飾用背景圓圈 */}
              <div className="absolute -top-10 -right-10 w-32 h-32 bg-duck-yellow/20 rounded-full blur-xl"></div>
              <div className="absolute -bottom-10 -left-10 w-32 h-32 bg-duck-blue/20 rounded-full blur-xl"></div>

              <div className="text-center mb-8 relative z-10">
                <h1 className="text-3xl font-extrabold text-duck-dark mb-2 tracking-tight">
                  <i className="fa-solid fa-plane-departure text-duck-blue mr-2 transform -rotate-12"></i>
                  DuckTravel
                </h1>
                <p className="text-slate-500 font-medium">智能旅費規劃助手</p>
              </div>

              <div className="space-y-5 relative z-10">
                <div>
                  <label className="block text-sm font-bold text-slate-700 mb-1 ml-1">旅行天數</label>
                  <div className="relative">
                    <i className="fa-regular fa-calendar absolute left-3 top-3.5 text-gray-400"></i>
                    <input 
                      type="number" value={days} onChange={(e) => setDays(e.target.value)}
                      className="w-full pl-10 p-3 rounded-xl border border-gray-200 focus:ring-4 focus:ring-duck-blue/20 focus:border-duck-blue outline-none transition bg-slate-50"
                      placeholder="例如：5"
                    />
                  </div>
                </div>

                <div>
                  <label className="block text-sm font-bold text-slate-700 mb-1 ml-1">總預算 ($)</label>
                  <div className="relative">
                    <i className="fa-solid fa-dollar-sign absolute left-3.5 top-3.5 text-gray-400"></i>
                    <input 
                      type="number" value={budget} onChange={(e) => setBudget(e.target.value)}
                      className="w-full pl-10 p-3 rounded-xl border border-gray-200 focus:ring-4 focus:ring-duck-yellow/30 focus:border-duck-yellow outline-none transition bg-slate-50"
                      placeholder="例如：10000"
                    />
                  </div>
                </div>

                <button 
                  onClick={handleCalculateAndSave} disabled={loading}
                  className="w-full bg-duck-blue hover:bg-blue-600 text-white font-bold py-3.5 px-4 rounded-xl transition duration-300 transform hover:scale-[1.02] active:scale-95 shadow-lg shadow-blue-500/30 disabled:opacity-70 disabled:cursor-not-allowed flex justify-center items-center"
                >
                  {loading ? (
                    <><i className="fa-solid fa-circle-notch fa-spin mr-2"></i> 處理中...</>
                  ) : (
                    <><i className="fa-solid fa-calculator mr-2"></i> 開始計算</>
                  )}
                </button>

                {status && (
                  <div className={`mt-2 text-center text-sm font-bold ${status.includes("錯誤") ? "text-red-500" : "text-green-600"}`}>
                    {status}
                  </div>
                )}
              </div>
            </div>

            {/* 卡片：歷史紀錄區 (保持 Duck Style) */}
            {history.length > 0 && (
              <div className="w-full max-w-md animate-fade-in-up">
                <div className="flex items-center justify-between mb-4 px-2">
                  <h2 className="text-xl font-bold text-duck-dark">
                    <i className="fa-solid fa-clock-rotate-left mr-2 text-duck-yellow"></i>
                    過往紀錄
                  </h2>
                  <span className="text-xs font-bold bg-white text-duck-blue px-2 py-1 rounded-full shadow-sm">{history.length}</span>
                </div>
                
                <div className="space-y-3">
                  {history.map((item) => (
                    <div key={item.id} className="bg-white/80 backdrop-blur-sm p-4 rounded-xl shadow-sm border border-duck-blue/10 hover:border-duck-yellow transition group">
                      <div className="flex justify-between items-center">
                        <div>
                          <div className="flex items-baseline space-x-2">
                            <span className="text-lg font-bold text-slate-800">${item.totalBudget}</span>
                            <span className="text-sm text-slate-500">/ {item.days} 天</span>
                          </div>
                          <p className="text-sm text-slate-600 mt-1">
                            每日可用: <span className="text-duck-blue font-extrabold bg-blue-50 px-1.5 py-0.5 rounded">${item.dailyAverage}</span>
                          </p>
                        </div>
                        <button 
                          onClick={() => handleDelete(item.id)}
                          className="w-8 h-8 flex items-center justify-center rounded-full text-slate-300 hover:bg-red-50 hover:text-red-500 transition"
                        >
                          <i className="fa-solid fa-trash-can"></i>
                        </button>
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            )}

          </div>
        );
      }

      const root = createRoot(document.getElementById('root'));
      root.render(<App />);
    </script>
  </body>
</html>
